<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Update User</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .header-user {
            background-color: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<!-- Header -->
<div class="header-user">
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <h4 class="mb-0">Update User</h4>
            </div>
            <div class="col-auto">
                <span th:text="'Logged in as: ' + ${currentUser.firstName} + ' ' + ${currentUser.lastName}"></span>
                <span th:if="${currentUser.roles != null && #arrays.contains(currentUser.roles, 'admin')}"
                      class="badge bg-primary ms-2">ADMIN</span>
            </div>
            <div class="col-auto">
                <a href="/admin" class="btn btn-secondary btn-sm me-2">Back to Admin Panel</a>
                <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="form-container">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Edit User Information</h5>
            </div>
            <div class="card-body">
                <!-- Error Messages -->
                <div th:if="${param.error == 'update_failed'}" class="alert alert-danger">
                    Failed to update user. Please check the data and try again.
                </div>
                <div th:if="${param.error == 'system_error'}" class="alert alert-danger">
                    System error occurred. Please try again later.
                </div>
                <div th:if="${param.error == 'email_exists'}" class="alert alert-danger">
                    User with this email already exists!
                </div>

                <!-- Update Form -->
                <form th:action="@{/admin/editUser}" method="post" th:object="${userDao}">
                    <!-- Hidden ID field -->
                    <input type="hidden" th:field="*{id}"/>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="firstName" class="form-label">First Name *</label>
                            <input type="text"
                                   class="form-control"
                                   id="firstName"
                                   th:field="*{firstName}"
                                   required
                                   placeholder="Enter first name">
                            <div class="error-message" th:if="${#fields.hasErrors('firstName')}"
                                 th:errors="*{firstName}"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="lastName" class="form-label">Last Name *</label>
                            <input type="text"
                                   class="form-control"
                                   id="lastName"
                                   th:field="*{lastName}"
                                   required
                                   placeholder="Enter last name">
                            <div class="error-message" th:if="${#fields.hasErrors('lastName')}"
                                 th:errors="*{lastName}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email"
                                   class="form-control"
                                   id="email"
                                   th:field="*{email}"
                                   required
                                   placeholder="Enter email">
                            <div class="error-message" th:if="${#fields.hasErrors('email')}"
                                 th:errors="*{email}"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="age" class="form-label">Age</label>
                            <input type="number"
                                   class="form-control"
                                   id="age"
                                   th:field="*{age}"
                                   min="1"
                                   max="120"
                                   placeholder="Enter age">
                            <div class="error-message" th:if="${#fields.hasErrors('age')}"
                                 th:errors="*{age}"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password"
                               class="form-control"
                               id="password"
                               th:field="*{password}"
                               placeholder="Enter new password (leave empty to keep current)">
                        <div class="form-text">
                            Leave password field empty if you don't want to change it.
                        </div>
                        <div class="error-message" th:if="${#fields.hasErrors('password')}"
                             th:errors="*{password}"></div>
                    </div>

                    <!-- Roles Selection -->
                    <div class="mb-3">
                        <label class="form-label">Roles *</label>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   value="user"
                                   id="roleUser"
                                   th:field="*{roles}">
                            <label class="form-check-label" for="roleUser">
                                USER
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   value="admin"
                                   id="roleAdmin"
                                   th:field="*{roles}">
                            <label class="form-check-label" for="roleAdmin">
                                ADMIN
                            </label>
                        </div>
                        <div class="error-message" th:if="${#fields.hasErrors('roles')}"
                             th:errors="*{roles}"></div>
                    </div>

                    <!-- Current User Info (for reference) -->
                    <div class="mb-3 p-3 bg-light rounded">
                        <h6>Current User Information:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Name:</strong>
                                <span th:text="*{firstName} + ' ' + *{lastName}"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Email:</strong>
                                <span th:text="*{email}"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>Age:</strong>
                                <span th:text="*{age}"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Current Roles:</strong>
                                <span th:text="*{stringRole}"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Form Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="/admin" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Update User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Client-side validation
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const passwordField = document.getElementById('password');

        form.addEventListener('submit', function(event) {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const roleCheckboxes = document.querySelectorAll('input[name="roles"]:checked');

            // Basic validation
            if (!firstName || !lastName || !email) {
                alert('Please fill in all required fields (First Name, Last Name, Email).');
                event.preventDefault();
                return;
            }

            if (roleCheckboxes.length === 0) {
                alert('Please select at least one role.');
                event.preventDefault();
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                event.preventDefault();
                return;
            }
        });

        // Age validation
        const ageField = document.getElementById('age');
        if (ageField) {
            ageField.addEventListener('change', function() {
                const age = parseInt(this.value);
                if (age && (age < 1 || age > 120)) {
                    this.setCustomValidity('Age must be between 1 and 120');
                } else {
                    this.setCustomValidity('');
                }
            });
        }
    });
</script>
</body>
</html>
